<!DOCTYPE HTML>
<html lang="ja-JP">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
<link rel="shortcut icon" href="./img/favicon.png">
<link rel="apple-touch-icon-precomposed" href="./img/favicon.png">
<title>モニター - 手書き花火</title>
<style>
* { box-sizing: border-box; }
*, *::before, *::after { will-change: all; }
body { margin: 0; background: #000; overflow: hidden; background: url(./img/bg.jpg); background-size: cover;}
.fireworks { position: absolute; left: 50%; bottom: 110%; transform-origin: center center;}
.fireworks .fireLine {  width: 10px; height: 200px; background: url(./img/fireline.svg) no-repeat center center; display: inline-block; }
.fireworks .burst { position: absolute; left: -320px; }
.fireworks .flash { animation: flashAnime 1s ease-out; }
@keyframes flashAnime {
    0% {-webkit-filter: brightness(1000%)}
    100% {-webkit-filter: brightness(100%)}
}
</style>
</head>
<body>

<main id="sky"></main>

<script src="https://cdn.mlkcca.com/v0.6.0/milkcocoa.js"></script>
<script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/1.0.0/anime.min.js"></script>
<script src="./js/common.js"></script>
<script>
// ***
// 設定
// ***
var count = 0;
var fileNo, timerId;
var randPro = 2; // **分の1の確率で他の人の花火を表示
var winW = $(window).width();
var winH = $(window).height()
var parameter = location.search.split('?')[1];
var $sky = $('#sky');
var $fireLine = $('.fireLine');
audio = {};


// ***
// 乱数関数
// ***
// 整数のみ
function rand(mn, mx){
    let r = Math.round(Math.random() * (mx - mn)) + mn;
    return r;
}

// 小数点付き
function randPoint(mn, mx, n){
    let pow = Math.pow(10, n);
    let r = Math.round((Math.random() * (mx - mn) + mn) * pow) / pow;
    return r;
}


// ***
// 音を作成し再生完了後、削除する
// ***
function createAudio(file, count){
    audio['obj' + count] = new Audio();
    audio['obj' + count].src = `./audio/${file}.webm`;
    audio['obj' + count].volume = 0.1;
    audio['obj' + count].play();
    audio['obj' + count].addEventListener('ended', function(){
        delete audio['obj' + 1];
    }, false);
}


// ***
// BGM
// ***
function createBgm(){
    audio.bgm = new Audio();
    audio.bgm.src = './audio/bgm.webm';
    audio.bgm.volume = 0.5;
    audio.bgm.loop = true;
    audio.bgm.play();
}
createBgm();


/***
* 発火
***/
function firingAnime($targetFire, count, fileNo){
    var now = $.now();

    $targetFire.append(`
        <span class="burst">
            <img src="./img/output/img${fileNo}.png?${now}" class="img flash" id="img${count}">
        </span>
    `);

    $targetFire.ready(function(){
        var $img = $(`#img${count}`);
        var num = 0;

        anime({
            targets: `#fireworks${count}`,
            scale: {
                value: [0, randPoint(0.4, 0.6, 1)],
                duration: 500,
                easing: 'easeOutQuad'
            },
            opacity: {
                value: [1, 0],
                delay: 500,
                duration: 2000,
                easing: 'easeOutQuad'
            },
            translateY: {
                value: [-100, -80],
                delay: 500,
                duration: 3000,
                easing: 'easeOutQuad'
            },
            begin: function(){
                createAudio('burst', count);
            },
            complete: function(){
                createAudio('parapara', count);
                anime.remove(`#fireworks${count}`);
                $targetFire.remove();
            },
            loop: false
        });
  });
}


/***
* 打ち上げ
***/
function launchFire(count, locationX, fileNo){
    var $targetFire = $(`#fireworks${count}`);
    var tuningY = rand(-200, 200);

    anime({
        targets: `#fireworks${count}`,
        translateY: [winH, 500 - tuningY],
        duration: rand(1000, 2000),
        easing: 'easeOutQuad',
        opacity: {
            value: [1, 0],
            duration: 2000,
            easing: 'easeOutQuad'
        },
        scaleX: {
            value: [1, -1],
            duration: 2000,
            direction: 'alternate',
            easing: 'easeOutQuad',
            loop: true
        },
        begin: function(){
            createAudio('launch', count);
            $targetFire.css({left: `${locationX}%`});
        },
        complete: function(){
            $(`#fireLine${count}`).remove();
            $targetFire.css({top: (200 - tuningY) + 'px'});
            firingAnime($targetFire, count, fileNo);
        },
        loop: false
    });
}


// ***
// 時々移動させながら着火
// ***
function startFire(fileNo) {
    timerId = setInterval(function(){
        count++;
        var randomNo = rand(1, randPro) == 1 ? rand(1, fileNo) : fileNo;

        $sky.append(`
            <i class="fireworks" id="fireworks${count}">
                <span class="fireLine" id="fireLine${count}"></span>
            </i>
        `);
        launchFire(count, rand(0, 100), randomNo);
    }, rand(1000, 2000));
}


// ***
// 作成通知を取得して花火を打ち上げ
// ***
DS.on('send', function(data){
    clearInterval(timerId);
    if(timerId) {clearInterval(timerId)};
    startFire(data.value.imgId);
});


// ***
// テストモード
// ***
function getApi(){
    return $.get('./api.php');
}

function testMode(){
    getApi().done(function(data){
        startFire(data);
    });
}

if(parameter == 'test'){
    testMode();
}


// ***
// 画像数取得
// ***
function getHanabiNum(){
    getApi().done(function(data){
        alert(`現在の花火画像数は、${data} です`);
    });
}

if(parameter == 'num'){
    getHanabiNum()
}


</script>
</body>
</html>
